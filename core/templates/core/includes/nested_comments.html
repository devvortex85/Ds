{% load dict_tags %}

<!-- Nested comment rendering template -->
<article id="comment-{{ node.id }}" class="comment-item">
    <!-- Comment indentation markers - one for each level -->
    {% if level_adjustment %}
        {% with adjusted_level=node.level|add:level_adjustment %}
            {% for i in "12345"|make_list %}
                {% if forloop.counter <= adjusted_level %}
                    <div class="comment-indent indent-level-{{ forloop.counter }}"></div>
                {% endif %}
            {% endfor %}
        {% endwith %}
    {% else %}
        {% with level=node.level %}
            {% for i in "12345"|make_list %}
                {% if forloop.counter <= level %}
                    <div class="comment-indent indent-level-{{ forloop.counter }}"></div>
                {% endif %}
            {% endfor %}
        {% endwith %}
    {% endif %}
    
    <div class="comment-wrapper">
        <!-- Vote controls -->
        <div class="vote-column">
            {% with comment=node %}
                {% include 'core/includes/comment_rendering.html' %}
            {% endwith %}
        </div>
        
        <!-- Comment content -->
        <div class="comment-content-column">
            <div class="comment-meta">
                {% with comment=node %}
                    {% include 'core/includes/comment_author.html' %}
                {% endwith %}
            </div>
            
            <div class="comment-body">
                {{ node.content|linebreaks }}
            </div>
            
            <div class="comment-actions">
                {% if user.is_authenticated %}
                <button type="button" class="comment-action-btn reply-toggle" 
                        data-comment-id="{{ node.id }}"
                        aria-controls="reply-form-{{ node.id }}"
                        aria-expanded="false">
                    <i class="bi bi-reply-fill" aria-hidden="true"></i> Reply
                </button>
                {% endif %}
            </div>
            
            <!-- Reply form (hidden by default) -->
            {% if user.is_authenticated %}
            <div id="reply-form-{{ node.id }}" class="reply-form" aria-hidden="true">
                <form action="{% url 'add_comment' post.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ node.id }}">
                    <div class="form-group">
                        <textarea name="content" class="form-control" rows="3" placeholder="What are your thoughts?" required></textarea>
                    </div>
                    <div class="reply-form-actions">
                        <button type="button" class="btn btn-outline-secondary btn-sm cancel-reply"
                                data-comment-id="{{ node.id }}"
                                aria-controls="reply-form-{{ node.id }}">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</article>

<!-- For comments that reach the maximum nesting depth, show "Continue Thread" link -->
{% if max_depth and node.level >= max_depth and not node.is_leaf_node %}
    <div class="deep-nesting-indicator">
        <a href="{% url 'comment_thread' node.id %}" class="continue-thread-link">
            <i class="bi bi-arrow-right-circle-fill me-1" aria-hidden="true"></i>
            Continue this thread ({{ node.get_descendant_count }} more repl{% if node.get_descendant_count != 1 %}ies{% else %}y{% endif %})
        </a>
    </div>
{% endif %}