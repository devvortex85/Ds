{% comment %}
  Template for displaying a comment thread with proper nesting structure
  
  Parameters:
  - comment: The root comment to display (required)
  - descendants: The descendants of the root comment (optional, will use get_descendants if not provided)
  - max_depth: Maximum level of nesting to display (default: 5)
  - level_adjustment: Adjustment to nesting level count (optional)
  - show_collapsed_count: Whether to show number of replies when collapsed (default: True)
  
  Usage:
  {% include 'core/includes/comment_thread_structure.html' with comment=root_comment %}
{% endcomment %}

{% load mptt_tags %}

<div class="comment-thread" id="thread-{{ comment.id }}" data-comment-id="{{ comment.id }}">
    <!-- Root comment -->
    <article id="comment-{{ comment.id }}" class="comment-item">
        <div class="comment-wrapper">
            <!-- Vote controls -->
            <div class="vote-column">
                {% include 'core/includes/comment_rendering.html' %}
            </div>
            
            <!-- Comment content -->
            <div class="comment-content-column">
                <div class="comment-meta">
                    <span class="collapse-indicator">â–¼</span>
                    {% include 'core/includes/comment_author.html' %}
                </div>
                
                <div class="comment-body">
                    {{ comment.content|linebreaks }}
                </div>
                
                {% include 'core/includes/comment_reply_form.html' with post=comment.post %}
                
                <!-- Collapsed thread comment count (shown when thread is collapsed) -->
                {% if show_collapsed_count|default:True and not comment.is_leaf_node %}
                <div class="collapsed-count">
                    <i class="bi bi-chat-fill me-1" aria-hidden="true"></i>
                    {{ comment.get_descendant_count }} more repl{% if comment.get_descendant_count != 1 %}ies{% else %}y{% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </article>
    
    <!-- Nested comments with thread collapse line -->
    {% if not comment.is_leaf_node %}
        <!-- Thread collapse line (clickable to collapse/expand thread) -->
        <div class="thread-collapse-line" data-thread-id="{{ comment.id }}" role="button" tabindex="0" aria-label="Collapse or expand comment thread"></div>
        
        <div class="nested-comments" aria-label="Replies to this comment">
            {% if descendants %}
                {% for node in descendants %}
                    {% with max_depth=max_depth|default:5 level_adjustment=level_adjustment|default:"0" %}
                        {% include 'core/includes/nested_comments.html' %}
                    {% endwith %}
                {% endfor %}
            {% elif comment.child_comments %}
                {% for node in comment.child_comments %}
                    {% with max_depth=max_depth|default:5 level_adjustment=level_adjustment|default:"0" %}
                        {% include 'core/includes/nested_comments.html' %}
                    {% endwith %}
                {% endfor %}
            {% else %}
                {% for node in comment.get_descendants %}
                    {% with max_depth=max_depth|default:5 level_adjustment=level_adjustment|default:"0" %}
                        {% include 'core/includes/nested_comments.html' %}
                    {% endwith %}
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}
</div>