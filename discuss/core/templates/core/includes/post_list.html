{% load el_pagination_tags reputation_tags %}

{% paginate posts %}
{% for post in posts %}
<div class="card mb-3 post-card">
    <div class="card-body">
        <div class="d-flex">
            <!-- Votes section -->
            <div class="vote-controls me-3">
                {% if user.is_authenticated %}
                <a href="{% url 'vote_post' post.id 'upvote' %}" class="vote-btn upvote-btn {% if user_post_votes and post.id in user_post_votes and user_post_votes|get_item:post.id == 1 %}active{% endif %}" data-post-id="{{ post.id }}" data-vote-type="upvote">
                    <i class="fas fa-arrow-up"></i>
                </a>
                {% else %}
                <a href="{% url 'login' %}" class="vote-btn">
                    <i class="fas fa-arrow-up"></i>
                </a>
                {% endif %}
                
                <div class="vote-count" id="post-{{ post.id }}-votes">{{ post.vote_count }}</div>
                
                {% if user.is_authenticated %}
                <a href="{% url 'vote_post' post.id 'downvote' %}" class="vote-btn downvote-btn {% if user_post_votes and post.id in user_post_votes and user_post_votes|get_item:post.id == -1 %}active{% endif %}" data-post-id="{{ post.id }}" data-vote-type="downvote">
                    <i class="fas fa-arrow-down"></i>
                </a>
                {% else %}
                <a href="{% url 'login' %}" class="vote-btn">
                    <i class="fas fa-arrow-down"></i>
                </a>
                {% endif %}
            </div>
            
            <!-- Post content -->
            <div class="post-content">
                <!-- Post header info -->
                <div class="post-meta mb-2">
                    <a href="{% url 'community_detail' post.community.id %}" class="community-link">d/{{ post.community.name }}</a>
                    <span class="text-muted">â€¢ Posted by 
                        <a href="{% url 'profile' post.author.username %}" class="user-link">u/{{ post.author.username }}</a>
                        {% if post.author.profile.country %}
                        <img src="{{ post.author.profile.country.flag }}" alt="{{ post.author.profile.country.code }}" class="country-flag" style="width: 16px; height: 12px;" /> 
                        {% endif %}
                        {{ post.created_at|timesince }} ago
                    </span>
                </div>
                
                <!-- Post title -->
                <h5 class="card-title">
                    <a href="{% url 'post_detail' post.id %}" class="post-title-link">{{ post.title }}</a>
                    {% if post.post_type == 'link' %}
                    <small><a href="{{ post.url }}" target="_blank" class="text-muted url-link">
                        <i class="fas fa-external-link-alt"></i> {{ post.url|truncatechars:30 }}
                    </a></small>
                    {% endif %}
                </h5>
                
                <!-- Post content preview -->
                {% if post.post_type == 'text' and post.content %}
                <div class="post-preview">
                    <p class="card-text">{{ post.content|truncatewords:50 }}</p>
                </div>
                {% endif %}
<!-- Post tags -->
                {% if post.tags.all %}
                <div class="post-tags mb-2">
                    {% for tag in post.tags.all %}
                        <a href="{% url 'home' %}?tag={{ tag.slug }}" class="badge bg-light text-dark text-decoration-none me-1">
                            <i class="fas fa-tag me-1"></i>{{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Post tags -->
                {% if post.tags.all %}
                <div class="post-tags mb-2">
                    {% for tag in post.tags.all %}
                        <a href="{% url 'home' %}?tag={{ tag.slug }}" class="badge bg-light text-dark text-decoration-none me-1">
                            <i class="fas fa-tag me-1"></i>{{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Post footer actions -->
                <div class="post-actions mt-2">
                    <a href="{% url 'post_detail' post.id %}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-comment"></i> {{ post.comment_count|default:0 }} Comments
                    </a>
                    <a href="{% url 'post_detail' post.id %}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-share"></i> Share
                    </a>
                    {% if user == post.author %}
                    <a href="{% url 'delete_post' post.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this post?')">
                        <i class="fas fa-trash"></i> Delete
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% empty %}
<div class="card mb-4">
    <div class="card-body text-center">
        <p class="text-muted">No posts yet...</p>
        {% if community and is_member %}
        <a href="{% url 'create_text_post' community.id %}" class="btn btn-primary">Create the first post</a>
        {% endif %}
    </div>
</div>
{% endfor %}

{% show_more %}
